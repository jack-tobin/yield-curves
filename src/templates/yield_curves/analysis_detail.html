{% extends 'base.html' %}

{% block title %}{{ analysis.name }} - Analysis Detail{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'yield_curves:analyses_list' %}">My Analyses</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ analysis.name }}</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">{{ analysis.name }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Created:</strong> {{ analysis.created_at|date:"F d, Y H:i" }}</p>
                            <p><strong>Last Modified:</strong> {{ analysis.updated_at|date:"F d, Y H:i" }}</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Bond Scatters Management Section -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Bond Scatters</h5>
                            <button id="add-scatter-btn" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> Add Scatter
                            </button>
                        </div>

                        <!-- Existing Scatters List -->
                        <div id="scatters-list" class="mb-4">
                            {% if bond_scatters %}
                                <div class="row">
                                    {% for scatter in bond_scatters %}
                                    <div class="col-md-4 mb-3">
                                        <div class="card scatter-card" data-scatter-id="{{ scatter.id }}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1">{{ scatter.country }} {{ scatter.date|date:"M d, Y" }}</h6>
                                                        <small class="text-muted">{{ scatter.date }}</small>
                                                    </div>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item view-scatter-btn" href="#" data-scatter-id="{{ scatter.id }}">
                                                                <i class="fas fa-eye"></i> View Data
                                                            </a></li>
                                                            <li><a class="dropdown-item delete-scatter-btn" href="#" data-scatter-id="{{ scatter.id }}">
                                                                <i class="fas fa-trash text-danger"></i> Delete
                                                            </a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input scatter-checkbox" type="checkbox"
                                                           id="scatter-{{ scatter.id }}" data-scatter-id="{{ scatter.id }}" checked>
                                                    <label class="form-check-label" for="scatter-{{ scatter.id }}">
                                                        Show in chart
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No bond scatters added yet. Click "Add Scatter" to create your first scatter plot.
                                </div>
                            {% endif %}
                        </div>

                        <!-- Chart Controls -->
                        <div class="mb-3">
                            <div class="d-flex gap-2">
                                <button id="refresh-data-btn" class="btn btn-outline-info">
                                    <i class="fas fa-sync"></i> Refresh Data
                                </button>
                                <button id="clear-chart-btn" class="btn btn-outline-secondary">
                                    <i class="fas fa-eraser"></i> Clear Chart
                                </button>
                                <div class="ms-auto">
                                    <button id="select-all-btn" class="btn btn-outline-primary btn-sm">Select All</button>
                                    <button id="deselect-all-btn" class="btn btn-outline-secondary btn-sm">Deselect All</button>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Container -->
                        <div class="row">
                            <div class="col-12">
                                <div id="chart-container" style="height: 600px; position: relative; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                                    <canvas id="bond-scatter-chart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div id="chart-info" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="{% url 'yield_curves:analyses_list' %}" class="btn btn-secondary">Back to Analyses</a>
                    <button class="btn btn-primary" onclick="alert('Edit functionality coming soon!')">Edit Analysis</button>
                    <form method="post" action="{% url 'yield_curves:delete_analysis' analysis.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this analysis?')">Delete Analysis</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Scatter Modal -->
<div class="modal fade" id="addScatterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Bond Scatter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-scatter-form">
                    <div class="mb-3">
                        <label for="scatter-country" class="form-label">Country</label>
                        <select id="scatter-country" class="form-select" required>
                            <option value="">Select Country</option>
                            <option value="DE">Germany (DE)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scatter-date" class="form-label">Date</label>
                        <input type="date" id="scatter-date" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="save-scatter-btn" class="btn btn-primary">Add Scatter</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let bondChart = null;
const analysisId = {{ analysis.id }};
const hasScatters = {{ bond_scatters|length }} > 0;
const colors = [
    'rgba(54, 162, 235, 0.8)',   // Blue
    'rgba(255, 99, 132, 0.8)',   // Red
    'rgba(75, 192, 192, 0.8)',   // Teal
    'rgba(255, 206, 86, 0.8)',   // Yellow
    'rgba(153, 102, 255, 0.8)',  // Purple
    'rgba(255, 159, 64, 0.8)',   // Orange
    'rgba(199, 199, 199, 0.8)',  // Grey
    'rgba(83, 102, 255, 0.8)',   // Indigo
    'rgba(255, 99, 255, 0.8)',   // Pink
    'rgba(99, 255, 132, 0.8)'    // Green
];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize event listeners
    initializeEventListeners();

    // Set default date to today
    document.getElementById('scatter-date').valueAsDate = new Date();

    // Always initialize chart with empty axes
    initializeEmptyChart();

    // Auto-load chart if there are scatters
    if (hasScatters) {
        loadAllSelectedScatters();
    }
});

function initializeEventListeners() {
    // Add scatter button
    document.getElementById('add-scatter-btn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('addScatterModal'));
        modal.show();
    });

    // Save scatter button
    document.getElementById('save-scatter-btn').addEventListener('click', addNewScatter);

    // Chart control buttons
    document.getElementById('clear-chart-btn').addEventListener('click', clearChart);
    document.getElementById('refresh-data-btn').addEventListener('click', refreshAllData);
    document.getElementById('select-all-btn').addEventListener('click', selectAllScatters);
    document.getElementById('deselect-all-btn').addEventListener('click', deselectAllScatters);

    // Scatter management buttons (event delegation)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-scatter-btn')) {
            e.preventDefault();
            const scatterId = e.target.dataset.scatterId;
            deleteScatter(scatterId);
        }

        if (e.target.classList.contains('view-scatter-btn')) {
            e.preventDefault();
            const scatterId = e.target.dataset.scatterId;
            viewScatterData(scatterId);
        }
    });

    // Checkbox change events (event delegation) - auto-update chart
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('scatter-checkbox')) {
            loadAllSelectedScatters();
        }
    });
}

function selectAllScatters() {
    const checkboxes = document.querySelectorAll('.scatter-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    loadAllSelectedScatters();
}

function deselectAllScatters() {
    const checkboxes = document.querySelectorAll('.scatter-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    loadAllSelectedScatters();
}

async function addNewScatter() {
    const country = document.getElementById('scatter-country').value;
    const date = document.getElementById('scatter-date').value;

    if (!country || !date) {
        alert('Please select both country and date');
        return;
    }

    const saveBtn = document.getElementById('save-scatter-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Adding...';
    saveBtn.disabled = true;

    try {
        const response = await fetch(`/yield-curves/analysis/${analysisId}/add_scatter/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ country, date })
        });

        const data = await response.json();

        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addScatterModal'));
            modal.hide();

            // Refresh the page to show new scatter
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error adding scatter:', error);
        alert('Error adding scatter. Please try again.');
    } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

async function deleteScatter(scatterId) {
    if (!confirm('Are you sure you want to delete this scatter?')) {
        return;
    }

    try {
        const response = await fetch(`/yield-curves/analysis/${analysisId}/scatter/${scatterId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });

        const data = await response.json();

        if (data.success) {
            // Remove scatter card from UI
            const scatterCard = document.querySelector(`[data-scatter-id="${scatterId}"]`);
            if (scatterCard) {
                scatterCard.closest('.col-md-4').remove();
            }

            // Update chart
            loadAllSelectedScatters();

            // Show empty state if no scatters left
            const remainingScatters = document.querySelectorAll('.scatter-card');
            if (remainingScatters.length === 0) {
                document.getElementById('scatters-list').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No bond scatters added yet. Click "Add Scatter" to create your first scatter plot.
                    </div>
                `;
                initializeEmptyChart();
            }
        } else {
            alert('Error deleting scatter');
        }
    } catch (error) {
        console.error('Error deleting scatter:', error);
        alert('Error deleting scatter. Please try again.');
    }
}

async function loadAllSelectedScatters() {
    const selectedScatters = Array.from(document.querySelectorAll('.scatter-checkbox:checked'))
        .map(cb => cb.dataset.scatterId);

    if (selectedScatters.length === 0) {
        initializeEmptyChart();
        document.getElementById('chart-info').innerHTML = '';
        return;
    }

    try {
        const response = await fetch(`/yield-curves/analysis/${analysisId}/all_scatters_data/`);
        const data = await response.json();

        if (data.success) {
            // Filter data for selected scatters only
            const selectedData = data.scatters.filter(scatter =>
                selectedScatters.includes(scatter.scatter.id.toString())
            );

            if (selectedData.length > 0) {
                createMultiScatterChart(selectedData);
            } else {
                initializeEmptyChart();
                document.getElementById('chart-info').innerHTML = '';
            }
        } else {
            console.error('Error loading scatter data:', data.error);
        }
    } catch (error) {
        console.error('Error loading scatter data:', error);
    }
}

function createMultiScatterChart(scatterData) {
    const ctx = document.getElementById('bond-scatter-chart').getContext('2d');

    // Destroy existing chart if it exists
    if (bondChart) {
        bondChart.destroy();
    }



    // Prepare datasets
    const datasets = scatterData.map((scatter, index) => {
        const chartData = scatter.data.map(bond => ({
            x: bond.ttm_years,
            y: bond.yield,
            isin: bond.isin,
            coupon: bond.coupon,
            maturityDate: bond.maturity_date,
            description: bond.description
        }));

        return {
            label: scatter.scatter.display_name,
            data: chartData,
            backgroundColor: colors[index % colors.length],
            borderColor: colors[index % colors.length].replace('0.8', '1'),
            borderWidth: 1,
            pointRadius: 6,
            pointHoverRadius: 8
        };
    });

    bondChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time to Maturity (Years)'
                    },
                    beginAtZero: false
                },
                y: {
                    title: {
                        display: true,
                        text: 'Yield (%)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Bond Yield vs Time to Maturity - Multi-Scatter Analysis'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const point = context[0];
                            return `ISIN: ${point.raw.isin}`;
                        },
                        label: function(context) {
                            const point = context.raw;
                            return [
                                `Dataset: ${context.dataset.label}`,
                                `TTM: ${point.x} years`,
                                `Yield: ${point.y}%`,
                                `Coupon: ${point.coupon}%`,
                                `Maturity: ${point.maturityDate}`,
                                `Description: ${point.description.substring(0, 50)}...`
                            ];
                        }
                    }
                }
            }
        }
    });
}

function clearChart() {
    document.getElementById('chart-info').innerHTML = '';
    initializeEmptyChart();
}

async function refreshAllData() {
    await loadAllSelectedScatters();
}

async function viewScatterData(scatterId) {
    try {
        const response = await fetch(`/yield-curves/analysis/${analysisId}/scatter/${scatterId}/data/`);
        const data = await response.json();

        if (data.success) {
            const info = `
                Scatter: ${data.scatter.display_name}
                Bonds: ${data.count}
                Date: ${data.scatter.date}
                Country: ${data.scatter.country}
            `;
            alert(info);
        }
    } catch (error) {
        console.error('Error viewing scatter data:', error);
        alert('Error loading scatter data');
    }
}

function initializeEmptyChart() {
    const ctx = document.getElementById('bond-scatter-chart').getContext('2d');

    // Destroy existing chart if it exists
    if (bondChart) {
        bondChart.destroy();
    }

    bondChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time to Maturity (Years)'
                    },
                    beginAtZero: false
                },
                y: {
                    title: {
                        display: true,
                        text: 'Yield (%)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Bond Yield vs Time to Maturity'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>

<style>
.scatter-card {
    transition: transform 0.2s ease-in-out;
}

.scatter-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.dropdown-toggle::after {
    display: none;
}

.chart-controls {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}
</style>
{% endblock %}
